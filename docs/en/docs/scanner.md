# Scanner

The main part of ComicLib is only responsible for traversing the comic library. The judgment and analysis of comic files are all completed through scanners.

Scanners are divided into [built-in scanners](https://github.com/ComicLib/comiclib/tree/master/comiclib/scanner) and external scanners. All *.py files in the working directory will be loaded as external scanners.

For each candidate comic file (folder), scanners are executed sequentially in the order of the file name (regardless of whether it is built-in or not) to complete different tasks.

You can find some external scanners in the [official repository](https://github.com/ComicLib/scanner), or download those written by others. In addition, you can write it by yourself as long as you know some simple Python.

By default, in addition to scanning once at startup, the comic library will also be monitored at runtime.
Comics that have been scanned into the database will be skipped.
See [Settings](settings.md) to change the behavior.

## Built-in scanners

### 10-zip.py

Treat *.zip files as comic files.

### 20-ccloli.py

Parse comic files downloaded via [ccloli/E-Hentai-Downloader](https://github.com/ccloli/E-Hentai-Downloader).


### 21-hath.py

Parse comic folders downloaded via [Hentai@Home](https://ehwiki.org/wiki/Hentai@Home#H.40H_Downloader).

### 30-importEHdb.py

Import the corresponding metadata from [ehentai metadata database](https://sukebei.nyaa.si/user/gipaf23445).
The database api_dump.sqlite must be downloaded to the working directory before use, otherwise it will be skipped.

Environment variable settings:

| Environment variables | Description | Default value |
| ------- | ---- | ----- |
| `importEHdb_thumb` | Whether to import thumbnails from it (`True`/`False`) | `True` |
| `importEHdb_matchtitle` | Whether to match based on the title (`True`/`False`/`exact`), `exact` for exact matching, `True` for fuzzy matching | `True` |
| `importEHdb_matchtorrent` | Whether to match based on the torrent file names (`True`/`False`) | `True` |

Matching based on ehentai gid is always enabled.

### 40-thumb.py

Generate homepage thumbnails from comic files.

## Write your own scanners

Since scanners determine the order of execution based on file names, a number can be added at the beginning of the file name.
General agreement:

* Scanners starting with 1 determine whether it is a comic file based on the file type, and perform basic analysis (such as using the file name as the title and counting the number of pages);
* Scanners starting with 2 parse metadata of files downloaded through specific downloaders;
* Scanners starting with 3 perform post-processing on the previously obtained metadata;
* Scanners starting with 4 are responsible for generating thumbnails.

The basic structure of scanners is as follows
``` python
from pathlib import Path
from typing import Union
from pydantic import BaseSettings
# some import and pre-process
# this may be executed multiple times, thus should avoid things like opening files

# optional
class Settings(BaseSettings):
    myscanner_settingA: bool = True  # It is recommended to prefix with the scanner name
    myscanner_settingB: Union[bool, str] = True
settings = Settings()

class Scanner:
    '''Your docstrings'''

    # optional
    def __init__(self) -> None:
        # Some initializations will only be executed once
    
    def scan(self, path: Path, id: str, metadata: dict, prev_scanners: list[str]) -> bool:
        # Process each file/directory
        if xxx:
            ...
            return True
        else:
            return False
```
where `Scanner.scan` is the function that actually scans each file/directory.

The return value indicates whether the scanners were successfully processed (e.g. the file/directory is considered a valid comic, or whether there is modified metadata).
If all scripts get `False` after scanning, ComicLib considers that the file/directory is not a valid comic and will not save it in the database.
This return value is also used as a reference for subsequent scripts.

Parameters of `Scanner.scan`:

* `path`: file/directory path for the input comic.
* `id`: Unique ID generated by ComicLib, do not attempt to write this value.
* `metadata`: Metadata obtained after processing by the previous script. The fields include `title`, `subtitle` `source`, `pagecount`, `tags`, `categories`. The initial values are `None` or `set()`. scanners write the resulting metadata into this `dict`.
* `prev_scanners`: The name of the script that previously returned `True`.
